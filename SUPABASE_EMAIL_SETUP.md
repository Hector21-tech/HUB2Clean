# Supabase Email Confirmation Setup üìß

## Problem: Confirmation Emails Not Sending

N√§r nya anv√§ndare registrerar sig f√•r de inte confirmation emails. Detta beror p√• Supabase's default email provider som har extremt l√•ga rate limits.

## L√∂sningar

### Option 1: Disable Email Confirmation (Snabbaste f√∂r Testing) ‚ö°

**Rekommenderat f√∂r development och testing**

1. G√• till Supabase Dashboard
2. Navigera till: **Authentication ‚Üí Settings ‚Üí Email**
3. Hitta inst√§llningen: **"Enable email confirmations"**
4. **St√§ng av (disable)** denna inst√§llning
5. Klicka **Save**

**Resultat:**
- Anv√§ndare kan logga in direkt efter signup
- Ingen email confirmation kr√§vs
- Perfekt f√∂r development och testing

---

### Option 2: Configure Custom SMTP (Production Ready) üöÄ

**Rekommenderat f√∂r production**

#### Steg 1: V√§lj Email Provider
V√§lj en av f√∂ljande:
- **Resend** (Rekommenderad - gratis tier 3000 emails/m√•nad)
- **SendGrid** (Gratis tier 100 emails/dag)
- **Gmail SMTP** (Gratis men begr√§nsad)
- **AWS SES** (B√§st f√∂r stora volymer)

#### Steg 2: Konfigurera SMTP i Supabase

1. G√• till Supabase Dashboard
2. Navigera till: **Authentication ‚Üí Settings ‚Üí SMTP**
3. Klicka **Enable Custom SMTP**
4. Fyll i SMTP credentials:
   - **Host:** smtp.resend.com (eller din provider)
   - **Port:** 587 (eller 465 f√∂r SSL)
   - **Username:** Din SMTP username
   - **Password:** Din SMTP password/API key
   - **Sender Email:** noreply@yourdomain.com
   - **Sender Name:** Scout Hub
5. Klicka **Save**

#### Steg 3: Testa Email Sending

1. G√• till: **Authentication ‚Üí Settings ‚Üí Email Templates**
2. V√§lj "Confirm signup"
3. Klicka **Send test email**
4. Kontrollera att email kommer fram

---

## Current System Status ‚úÖ

### Fixed Issues:
1. ‚úÖ **User Sync Fixed** - `/api/users/sync` now properly syncs users to Prisma database
2. ‚úÖ **User Deletion Fixed** - Admin panel now deletes users from BOTH Prisma AND Supabase Auth
3. ‚úÖ **Organization Creation** - Should work once email confirmation is configured

### Environment Variables Required:

```bash
# .env.local
NEXT_PUBLIC_SUPABASE_URL=your_supabase_url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key  # Required for user deletion
DATABASE_URL=your_postgres_connection_string
DIRECT_URL=your_direct_connection_string
```

---

## Testing Workflow üß™

### F√∂r Development:
1. **Disable email confirmation** (Option 1)
2. Registrera ny anv√§ndare via `/signup`
3. Logga in direkt utan email confirmation
4. Skapa organization via `/dashboard`
5. Verifiera att anv√§ndaren finns i b√•de Supabase Auth och Prisma

### F√∂r Production:
1. **Configure custom SMTP** (Option 2)
2. Enable email confirmation
3. Test complete signup ‚Üí email ‚Üí confirmation ‚Üí login flow
4. Monitor email delivery rates i SMTP provider dashboard

---

## Troubleshooting üîß

### Problem: User exists in Auth but not in Database
**L√∂sning:** Delete user from Supabase Auth dashboard ‚Üí Re-register

### Problem: User exists in Database but not in Auth
**L√∂sning:** Delete user via Admin panel ‚Üí Re-register

### Problem: SUPABASE_SERVICE_ROLE_KEY missing
**L√∂sning:**
1. G√• till Supabase Dashboard ‚Üí Project Settings ‚Üí API
2. Kopiera "service_role" key (secret!)
3. L√§gg till i `.env.local` som `SUPABASE_SERVICE_ROLE_KEY=...`
4. Restart dev server: `pnpm dev`

### Problem: User can't create organization after signup
**L√∂sning:**
1. Check att `/api/users/sync` kallas efter login
2. Check browser console f√∂r errors
3. Check Supabase logs f√∂r auth errors
4. Verifiera att user finns i Prisma: `npx prisma studio`

---

## Architecture Flow üèóÔ∏è

### Successful Registration Flow:
```
1. User submits signup form ‚Üí /signup
2. Supabase Auth creates user
3. User metadata (firstName, lastName) saved to Supabase
4. [IF EMAIL CONFIRMATION DISABLED] User can login immediately
5. On first login ‚Üí AuthContext calls /api/users/sync
6. /api/users/sync creates user in Prisma database
7. User can now create organizations ‚Üí /api/organizations
```

### Successful Deletion Flow:
```
1. Admin clicks "Delete User" in admin panel
2. API route /api/admin/users/[id] (DELETE)
3. Step 1: Delete from Supabase Auth (using service role key)
4. Step 2: Delete from Prisma database (cascades to memberships)
5. User completely removed from system
6. User can re-register with same email
```

---

*Last updated: 2025-09-29*
*Generated by Claude Code*